name: System testing
on: workflow_dispatch
jobs:
  setup:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2
      - name: Compile protobufs
        run: sh protobufs/compile.sh
      - name: Build test env
        run: docker compose -f systest-docker-compose.yml up -d
    
  test:
    runs-on: self-hosted
    needs: [setup]
    steps:
      - name: Show test results
        run: docker compose -f systest-docker-compose.yml logs -f tg-test-service
      - name: Propagate test results
        run: docker wait tg-test-service
      - name: Check load balancing
        run: python test/analizers/analize_nginx_balancing.py
      - name: Shutdown one backend service
        run: docker compose -f systest-docker-compose.yml stop backend-service-2
      - name: Restart testing service
        run: docker compose -f systest-docker-compose.yml restart tg-test-service
      - name: Show test results
        run: docker compose -f systest-docker-compose.yml logs -f tg-test-service
      - name: Propagate test results
        run: docker wait tg-test-service
  
  cleanup:
    runs-on: self-hosted
    needs: [test]
    if: always()
    steps:
      - name: Shutdown
        run: docker compose -f systest-docker-compose.yml down
      - name: Cleanup
        run: docker image prune -a -f
  